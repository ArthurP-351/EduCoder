<!DOCTYPE html>
<html>
<head>
    <title>Test Feature Upload & Detection</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow: auto; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Feature Upload & Detection Test</h1>
    
    <div class="step info">
        <h3>Test Instructions:</h3>
        <ol>
            <li>Go to <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
            <li>Upload the feature definition file: <code>MOL Roles Features_副本.xlsx</code></li>
            <li>Go to any transcript page</li>
            <li>Check if the annotation tabs show "Conceptual" and "Discursive" (not "Sheet1")</li>
            <li>Use the buttons below to check localStorage data</li>
        </ol>
    </div>
    
    <div class="step">
        <h3>localStorage Debugging</h3>
        <button onclick="checkLocalStorage()">Check localStorage Data</button>
        <button onclick="clearLocalStorage()">Clear localStorage</button>
                 <button onclick="testDirectFormat()">Test Legacy Format Detection</button>
        <div id="localStorage-output"></div>
    </div>
    
    <div class="step">
        <h3>Test Feature Upload API</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <button onclick="testUpload()">Test Upload</button>
        <div id="upload-output"></div>
    </div>
    
    <script>
        function checkLocalStorage() {
            const output = document.getElementById('localStorage-output');
            const featureDefinitions = localStorage.getItem('feature-definitions');
            
            if (featureDefinitions) {
                try {
                    const data = JSON.parse(featureDefinitions);
                    
                                         // Test the detection logic from AnnotationPanel and transcript page
                     const isDirectFormat = typeof data === 'object' && 
                                           data !== null && 
                                           !data.categories && 
                                           !data.features &&
                                           Object.keys(data).length > 0;
                     const isLegacyFormat = data.categories && data.features;
                    
                    output.innerHTML = `
                        <h4>localStorage Data Found:</h4>
                        <p><strong>Data Type:</strong> ${typeof data}</p>
                        <p><strong>Object Keys:</strong> ${JSON.stringify(Object.keys(data))}</p>
                        <p><strong>Has categories property:</strong> ${!!data.categories}</p>
                        <p><strong>Has features property:</strong> ${!!data.features}</p>
                        <p><strong>Direct Format Detected:</strong> ${isDirectFormat}</p>
                        <p><strong>Legacy Format Detected:</strong> ${isLegacyFormat}</p>
                        
                        ${isDirectFormat ? `
                            <h5>Categories Found:</h5>
                            <ul>
                                ${Object.keys(data).map(cat => `
                                    <li><strong>${cat}:</strong> ${data[cat].length} features</li>
                                `).join('')}
                            </ul>
                        ` : ''}
                        
                        <h5>Full Data Structure:</h5>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } catch (error) {
                    output.innerHTML = `<p class="error">Error parsing localStorage data: ${error.message}</p>`;
                }
            } else {
                output.innerHTML = '<p>No localStorage data found. Upload a feature definition file first.</p>';
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('feature-definitions');
            document.getElementById('localStorage-output').innerHTML = '<p class="success">localStorage cleared!</p>';
        }
        
                 function testDirectFormat() {
             // Create test data in legacy format (what the app now expects)
             const testData = {
                 uploadedAt: new Date().toISOString(),
                 originalFileName: "test.xlsx",
                 isXLSX: true,
                 categories: ["Conceptual", "Discursive"],
                 features: {
                     "Conceptual": [
                         { "Code": "Off Task", "Definition": "Test definition 1" },
                         { "Code": "Recording", "Definition": "Test definition 2" }
                     ],
                     "Discursive": [
                         { "Code": "Math Claim", "Definition": "Test definition 3" },
                         { "Code": "Explain (Action)", "Definition": "Test definition 4" }
                     ]
                 }
             };
             
             localStorage.setItem('feature-definitions', JSON.stringify(testData));
             document.getElementById('localStorage-output').innerHTML = '<p class="success">Test legacy format data saved to localStorage!</p>';
             
             setTimeout(() => {
                 checkLocalStorage();
             }, 100);
         }
        
        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const output = document.getElementById('upload-output');
            
            if (!fileInput.files[0]) {
                output.innerHTML = '<p class="error">Please select a file first!</p>';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                output.innerHTML = '<p>Uploading...</p>';
                
                const response = await fetch('/api/upload-feature-definition', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    output.innerHTML = `
                        <div class="success">
                            <h4>Upload Successful!</h4>
                            <p><strong>Categories:</strong> ${JSON.stringify(result.categories)}</p>
                            <p><strong>Data saved to localStorage:</strong> ${result.storage.success}</p>
                            <pre>${JSON.stringify(result.storage.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    output.innerHTML = `<div class="error"><h4>Upload Failed:</h4><p>${result.message}</p></div>`;
                }
            } catch (error) {
                output.innerHTML = `<div class="error"><h4>Upload Error:</h4><p>${error.message}</p></div>`;
            }
        }
        
        // Auto-check localStorage on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html> 